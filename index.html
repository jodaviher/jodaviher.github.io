<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Carnaval</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
        
        /* Estilos unificados para selects, botones e inputs num√©ricos */
        select, button, input[type="number"] { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border: 1px solid #ccc; 
            font-size: 16px; 
            box-sizing: border-box; /* Asegura que el padding no rompa el ancho */
        }

        button { background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); border: none; font-weight: bold; cursor: pointer; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        .hidden { display: none; }

        /* Estilos para el bloque de radio buttons */
        .radio-group { background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .radio-option { margin-bottom: 8px; display: flex; align-items: center; }
        .radio-option input { width: auto; margin-right: 10px; margin-bottom: 0; transform: scale(1.2); }
        .radio-option label { margin-bottom: 0; font-weight: normal; }
    </style>
</head>
<body>
    <h3>üëë Registro de Urnas</h3>

    <label for="reinaSelect">1. Selecciona la Reina:</label>
    <select id="reinaSelect">
        <option value="">-- Elegir Reina --</option>
    </select>

    <div id="divLocal" class="hidden">
        <label for="localSelect">2. Selecciona el Local:</label>
        <select id="localSelect">
            <option value="">-- Elegir Local --</option>
        </select>
    </div>

    <div id="divTipo" class="hidden">
        <label for="tipoSelect">3. Tipo de Foto:</label>
        <select id="tipoSelect">
            <option value="">-- Elegir Actividad --</option>
            <option value="RECOGIDA">RECOGIDA</option>
            <option value="CLASIFICACION">CLASIFICACION</option>
            <option value="PESAJE">PESAJE</option>
        </select>
    </div>

    <div id="divPesajeExtra" class="hidden radio-group">
        <label>4. Datos del Pesaje:</label>
        
        <div class="radio-option">
            <input type="radio" id="optUnidades" name="tipoValor" value="Unidades">
            <label for="optUnidades">Valor en Unidades (Conteo manual)</label>
        </div>
        <div class="radio-option">
            <input type="radio" id="optPeso" name="tipoValor" value="Peso (Kg)" checked>
            <label for="optPeso">Valor en Peso (Kilogramos)</label>
        </div>
        
        <label for="inputValor" style="margin-top: 10px;">Ingrese la cantidad registrada:</label>
        <input type="number" id="inputValor" step="any" placeholder="Ej: 20 o 0.5">
    </div>

    <button id="btnEnviar" class="hidden">CONFIRMAR DATOS</button>

    <script>   
        let tg = window.Telegram.WebApp;
        tg.expand();

        let db = []; // Inicializamos la base de datos vac√≠a

        // Referencias al DOM
        const reinaSelect = document.getElementById('reinaSelect');
        const localSelect = document.getElementById('localSelect');
        const tipoSelect = document.getElementById('tipoSelect');
        const divLocal = document.getElementById('divLocal');
        const divTipo = document.getElementById('divTipo');
        const divPesajeExtra = document.getElementById('divPesajeExtra'); // Nuevo div
        const inputValor = document.getElementById('inputValor');         // Nuevo input
        const btnEnviar = document.getElementById('btnEnviar');

        // --- FUNCI√ìN PARA CARGAR LOS DATOS EXTERNOS ---
        async function cargarDatos() {
            try {
                // Fetch busca el archivo data.json en la misma ruta
                const respuesta = await fetch('data.json');
                if (!respuesta.ok) throw new Error('No se pudo cargar el archivo JSON');

                db = await respuesta.json();
                
                // --- NUEVO ORDENAMIENTO POR RUTA ---
                db.sort((a, b) => {
                    // Primero comparamos por ruta (Num√©rico ascendente)
                    if (a.ruta !== b.ruta) {
                        return a.ruta - b.ruta;
                    }
                    // Si la ruta es la misma, desempatamos alfab√©ticamente por nombre
                    return a.nombre.localeCompare(b.nombre);
                });
                
                console.log("Datos cargados y ordenados por Ruta.");

                popularReinas(); // Una vez cargados, llenamos el primer select
            } catch (error) {
                console.error("Error al cargar JSON:", error);
                alert("Error al cargar la lista de locales. Por favor, verifica tu conexi√≥n o recarga la app.");
            }
        }

        // Llenar el select de Reinas
        function popularReinas() {
            db.forEach((item, index) => {
                let opt = document.createElement('option');
                // Usamos el √≠ndice del array ya ordenado
                opt.value = index; 
                
                // --- NUEVA VISUALIZACI√ìN: "1 - Nombre (Barrio)" ---
                // Nos aseguramos que exista el campo ruta, si no, ponemos "?"
                const numRuta = item.ruta ? item.ruta : "?"; 
                opt.innerHTML = `${numRuta} - ${item.nombre} (${item.barrio})`;
                
                reinaSelect.appendChild(opt);
            });
        }

        // --- EVENTOS DE INTERFAZ ---

        reinaSelect.addEventListener('change', () => {
            localSelect.innerHTML = '<option value="">-- Elegir Local --</option>';
            divLocal.classList.add('hidden');
            divTipo.classList.add('hidden');
            divPesajeExtra.classList.add('hidden'); // Ocultar pesaje si cambia reina
            btnEnviar.classList.add('hidden');

            if(reinaSelect.value !== "") {
                const dataReina = db[reinaSelect.value];
                dataReina.locales.forEach(loc => {
                    let opt = document.createElement('option');
                    opt.value = loc;
                    opt.innerHTML = loc;
                    localSelect.appendChild(opt);
                });
                divLocal.classList.remove('hidden');
            }
        });

        localSelect.addEventListener('change', () => {
            if(localSelect.value !== "") {
                divTipo.classList.remove('hidden');
            } else {
                divTipo.classList.add('hidden');
                divPesajeExtra.classList.add('hidden');
                btnEnviar.classList.add('hidden');
            }
        });

        tipoSelect.addEventListener('change', () => {
            // L√≥gica para mostrar/ocultar campos de pesaje
            if(tipoSelect.value === "PESAJE") {
                divPesajeExtra.classList.remove('hidden');
                inputValor.value = ""; // Limpiar valor anterior
            } else {
                divPesajeExtra.classList.add('hidden');
            }

            // Mostrar bot√≥n si hay selecci√≥n
            if(tipoSelect.value !== "") {
                btnEnviar.classList.remove('hidden');
            } else {
                btnEnviar.classList.add('hidden');
            }
        });

        btnEnviar.addEventListener('click', () => {
            const dataReina = db[reinaSelect.value];
            let payload = {};

            // Validaci√≥n espec√≠fica para PESAJE
            if(tipoSelect.value === "PESAJE") {
                const valor = inputValor.value.trim();
                const tipoValorSeleccionado = document.querySelector('input[name="tipoValor"]:checked');
                
                // Validar que haya n√∫mero
                if(valor === "" || isNaN(valor)) {
                    tg.showPopup({title: 'Error', message: 'Por favor ingrese un valor num√©rico v√°lido para el pesaje.'});
                    return;
                }
                
                // Construir payload completo
                payload = {
                    reina: dataReina.nombre,
                    barrio: dataReina.barrio,
                    local: localSelect.value,
                    tipo: tipoSelect.value,
                    valor_registrado: valor,
                    unidad: tipoValorSeleccionado.value
                };

            } else {
                // Payload est√°ndar para RECOGIDA / CLASIFICACION
                payload = {
                    reina: dataReina.nombre,
                    barrio: dataReina.barrio,
                    local: localSelect.value,
                    tipo: tipoSelect.value,
                    valor_registrado: "N/A",
                    unidad: "N/A"
                };
            }

            // Enviar datos a Telegram
            tg.sendData(JSON.stringify(payload));
        });

        // INICIAR LA CARGA AL ABRIR LA APP
        cargarDatos();
    </script>
</body>
</html>
